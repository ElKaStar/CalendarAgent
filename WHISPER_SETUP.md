# Инструкция по настройке Whisper для распознавания голосовых сообщений

## Чек-лист установки и настройки

### 1. Установка зависимостей

#### Python зависимости:
```bash
pip install -r requirements.txt
```

Это установит:
- `openai-whisper>=20231117` - библиотека для распознавания речи
- Все остальные зависимости проекта

#### Системные зависимости (ffmpeg):

**Windows:**
1. Скачайте ffmpeg с https://ffmpeg.org/download.html
2. Распакуйте архив
3. Добавьте путь к `ffmpeg.exe` в переменную окружения PATH
4. Или поместите `ffmpeg.exe` в папку проекта

**Linux (Ubuntu/Debian):**
```bash
sudo apt-get update
sudo apt-get install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

**Проверка установки ffmpeg:**
```bash
ffmpeg -version
```

### 2. Настройка переменных окружения

Отредактируйте файл `.env` (скопируйте из `env.example`):

```env
# Провайдер для распознавания речи
STT_PROVIDER=whisper

# Остальные настройки...
TELEGRAM_BOT_TOKEN=ваш_токен
GIGACHAT_CLIENT_ID=ваш_client_id
GIGACHAT_CLIENT_SECRET=ваш_client_secret
# ...
```

**Важно:** `STT_PROVIDER=whisper` установлен по умолчанию, но можно явно указать.

### 3. Первый запуск и загрузка модели

При первом запуске бота с Whisper:

1. Модель `base` автоматически скачается (~1.5GB)
2. Модель будет сохранена в кэш (обычно `~/.cache/whisper/`)
3. При последующих запусках модель загружается из кэша (быстро)

**Время первой загрузки:** зависит от скорости интернета (обычно 2-5 минут)

**Место на диске:** ~1.5GB для модели `base`

### 4. Запуск бота

```bash
python bot.py
```

При первом запуске вы увидите в логах:
```
INFO - Загружаем модель Whisper 'base' (первый запуск, это может занять время)...
INFO - Модель Whisper 'base' успешно загружена и кэширована
```

### 5. Тестирование

#### Тест модуля Whisper (без Telegram):
```bash
python tests/test_whisper.py
```

Для полного теста поместите тестовый аудиофайл в `tests/resources/`:
- Формат: `.wav`, `.mp3` или `.ogg`
- Рекомендуется: `.wav` 16kHz, моно

#### Тест через Telegram:
1. Запустите бота
2. Отправьте голосовое сообщение боту
3. Бот должен:
   - Скачать файл
   - Конвертировать через ffmpeg
   - Распознать речь через Whisper
   - Создать событие в календаре

## Структура изменений

### Новые файлы:
- `stt_whisper.py` - модуль для работы с Whisper
- `tests/test_whisper.py` - тесты для модуля
- `tests/resources/README.md` - инструкция для тестовых файлов
- `WHISPER_SETUP.md` - этот файл

### Изменённые файлы:
- `bot.py` - обновлён обработчик голосовых сообщений
- `requirements.txt` - добавлен `openai-whisper`
- `env.example` - добавлен `STT_PROVIDER`

## Как это работает

1. **Получение голосового сообщения:**
   - Бот получает voice-файл от Telegram (обычно `.ogg`)

2. **Скачивание:**
   - Файл скачивается во временную директорию `temp/`

3. **Конвертация через ffmpeg:**
   - `.ogg` конвертируется в `.wav` (16kHz, моно) для оптимальной работы Whisper

4. **Распознавание:**
   - Модель Whisper `base` распознаёт речь (модель загружается один раз и кэшируется)

5. **Обработка текста:**
   - Распознанный текст передаётся в существующую логику обработки текстовых сообщений
   - Создаётся событие в Google Calendar

6. **Очистка:**
   - Временные файлы удаляются

## Устранение проблем

### Ошибка: "ffmpeg не установлен"
- Установите ffmpeg (см. раздел 1)
- Проверьте, что ffmpeg доступен в PATH: `ffmpeg -version`

### Ошибка: "Библиотека whisper не установлена"
- Установите: `pip install openai-whisper`
- Проверьте: `python -c "import whisper; print(whisper.__version__)"`

### Ошибка: "Не удалось загрузить модель Whisper"
- Проверьте подключение к интернету (первая загрузка модели)
- Проверьте место на диске (~1.5GB)
- Проверьте права доступа к `~/.cache/whisper/`

### Медленное распознавание
- Это нормально для CPU (обычно 5-15 секунд для коротких сообщений)
- Модель `base` - компромисс между скоростью и качеством
- Для ускорения можно использовать GPU (требует дополнительной настройки)

### Неправильное распознавание
- Убедитесь, что говорите на русском языке
- Говорите чётко, без фонового шума
- Whisper лучше работает с качественным аудио

## Альтернативы

Если Whisper не подходит, можно использовать Яндекс SpeechKit:

1. Установите в `.env`:
   ```env
   STT_PROVIDER=yandex
   STT_API_KEY=ваш_ключ
   STT_FOLDER_ID=ваш_folder_id
   ```

2. Получите ключи на https://cloud.yandex.ru/docs/speechkit/

## Дополнительная информация

- Документация Whisper: https://github.com/openai/whisper
- Модели Whisper: `tiny`, `base`, `small`, `medium`, `large`
- Текущая модель: `base` (оптимальный баланс скорости/качества для CPU)

