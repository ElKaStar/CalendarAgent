# Реализация дневника питания (Food Log)

## Выполнено

### 1. Структура модулей

Создана структура `features/food/` с модулями:

- `intent_router.py` - определение интента (еда vs календарь)
- `food_nlu.py` - парсинг сообщений о еде (rules-based)
- `food_db.py` - работа с БД (CRUD операции)
- `food_handlers.py` - обработчики команд и сообщений
- `README.md` - документация модуля

### 2. Интеграция в bot.py

- Расширена функция `init_db()` для создания таблицы `food_logs`
- Добавлен router в `handle_text_message()` и `handle_voice_message()`
- Зарегистрированы команды `/food_*` в роутере бота
- Обновлена справка `/help` с новыми командами

### 3. Функциональность

#### Определение интента

Router определяет, куда направить сообщение:

1. **Календарь** (высокий приоритет): явные календарные интенты (дата+время+встреча/запись/маникюр/врач)
2. **Еда**: ключевые слова о еде (еда, съел, завтрак, обед, ужин, перекус, названия продуктов)
3. **По умолчанию**: календарь (как раньше)

#### Парсинг еды (rules-based)

- Определение даты: сегодня, завтра, вчера, послезавтра, YYYY-MM-DD
- Определение типа приёма пищи: завтрак, обед, ужин, перекус
- Извлечение продуктов: разделители (запятые, точки с запятой, "и", "с")
- Извлечение количества: граммы, миллилитры

#### Команды

- `/food_help` - справка
- `/food_today` - записи за сегодня
- `/food_day YYYY-MM-DD` - лог за дату
- `/food_last N` - последние N записей
- `/food_sum YYYY-MM-DD` - сводка за день
- `/food_delete ID` - удалить запись
- `/food_export YYYY-MM-DD` - экспорт CSV

### 4. База данных

Таблица `food_logs`:

```sql
CREATE TABLE IF NOT EXISTS food_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    created_at TEXT NOT NULL,
    event_date TEXT NOT NULL,
    meal_type TEXT NOT NULL,
    items_json TEXT NOT NULL,
    raw_text TEXT NOT NULL,
    source TEXT DEFAULT 'telegram',
    parse_mode TEXT DEFAULT 'rules',
    tz TEXT NOT NULL
)
```

### 5. Backward Compatibility

✅ Все существующие функции календаря работают без изменений:
- Создание событий в Google Calendar
- Обработка голосовых сообщений через STT
- Команды календаря (/start, /help, /list, /cancel)
- Нормализация текста через GigaChat

✅ Новый функционал добавлен как отдельный модуль, не затрагивая существующий код

### 6. Логирование

Добавлено логирование:
- Когда сообщение направлено в FoodPipeline или CalendarPipeline
- Сохранение записей о еде
- Ошибки обработки

## Тестирование

Для тестирования:

1. Запустите бота: `python bot.py`
2. Отправьте сообщение о еде: "Еда: завтрак омлет и кофе"
3. Проверьте команды: `/food_today`, `/food_help`

## Структура файлов

```
CalendarAgent/
├── bot.py                          # Основной файл (обновлён)
├── env.example                     # Конфигурация (обновлён)
├── features/
│   ├── __init__.py
│   └── food/
│       ├── __init__.py
│       ├── intent_router.py        # Определение интента
│       ├── food_nlu.py              # Парсинг еды
│       ├── food_db.py               # Работа с БД
│       ├── food_handlers.py         # Обработчики команд
│       └── README.md                # Документация
└── FOOD_LOG_IMPLEMENTATION.md       # Этот файл
```

## Следующие шаги (опционально)

- Добавить LLM-режим парсинга (если нужен более точный парсинг)
- Добавить статистику по калориям (если есть база калорийности)
- Добавить экспорт в другие форматы (JSON, Excel)
- Добавить напоминания о приёмах пищи

