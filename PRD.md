# PRD: Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google Calendar —á–µ—Ä–µ–∑ GigaChat

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–æ–±—â–∏–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–°—Ç–µ–∫ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏](#—Å—Ç–µ–∫-–∏-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏)
4. [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
5. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Calendar](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-google-calendar)
6. [–õ–æ–≥–∏–∫–∞ Telegram-–±–æ—Ç–∞](#–ª–æ–≥–∏–∫–∞-telegram-–±–æ—Ç–∞)
7. [–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (STT)](#—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ-—Ä–µ—á–∏-stt)
8. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GigaChat](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-gigachat)
9. [Google Calendar - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è](#google-calendar--—Å–æ–∑–¥–∞–Ω–∏–µ-—Å–æ–±—ã—Ç–∏—è)
10. [SQLite - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π](#sqlite--—Ö—Ä–∞–Ω–µ–Ω–∏–µ-—Å–æ–±—ã—Ç–∏–π)
11. [–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ Telegram](#–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è-—á–µ—Ä–µ–∑-telegram)
12. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
13. [Graceful Shutdown](#graceful-shutdown)
14. [–°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#—Å—Ü–µ–Ω–∞—Ä–∏–π-–¥–ª—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
15. [–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞](#–∫–∞—á–µ—Å—Ç–≤–æ-–∫–æ–¥–∞)
16. [Troubleshooting](#troubleshooting)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google –ö–∞–ª–µ–Ω–¥–∞—Ä—ë–º —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GigaChat –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞.

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
2. –ë–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å (–µ—Å–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ) —á–µ—Ä–µ–∑ STT-–ø—Ä–æ–≤–∞–π–¥–µ—Ä
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ GigaChat –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤—Å—Ç—Ä–µ—á–∏ (JSON)
4. –°–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ –≤ Google –ö–∞–ª–µ–Ω–¥–∞—Ä–µ
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ SQLite
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
7. –ó–∞ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ Telegram

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –û–¥–∏–Ω Python-—Ñ–∞–π–ª (`bot.py`)
- Long polling (–±–µ–∑ –≤–µ–±—Ö—É–∫–æ–≤, HTTPS, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Linux-—Å–µ—Ä–≤–µ—Ä–µ –±–µ–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
- –ü—Ä–æ—Å—Ç–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Service Account –¥–ª—è Google Calendar

---

## –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–π **–û–î–ò–ù —Ñ–∞–π–ª** `bot.py`, –≤ –∫–æ—Ç–æ—Ä–æ–º:

1. –ï—Å—Ç—å –±–ª–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –∏ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
2. –ï—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ `.env` (—á–µ—Ä–µ–∑ `python-dotenv`)
3. –ï—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram-–±–æ—Ç–∞ (–Ω–∞ `aiogram` v3)
   - –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å GigaChat (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, –≤—ã–∑–æ–≤ API, –ø–∞—Ä—Å–∏–Ω–≥)
   - –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å STT (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å TODO)
   - –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Google Calendar (—Å–æ–∑–¥–∞–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
   - –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å SQLite (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
   - –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
   - –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `asyncio.run(main())`

–†–∞–∑–±–µ–π –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ **–ª–æ–≥–∏—á–Ω—ã–µ —Å–µ–∫—Ü–∏–∏** —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏:

```python
# =============================
# CONFIGURATION & SETTINGS
# =============================

# =============================
# DATABASE FUNCTIONS
# =============================

# =============================
# GIGACHAT INTEGRATION
# =============================

# =============================
# GOOGLE CALENDAR INTEGRATION
# =============================

# =============================
# SPEECH-TO-TEXT (STT)
# =============================

# =============================
# TELEGRAM BOT HANDLERS
# =============================

# =============================
# REMINDER WORKER
# =============================

# =============================
# MAIN APPLICATION
# =============================
```

---

## –°—Ç–µ–∫ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

- **Python 3.10+**
- **aiogram (v3)** ‚Äî –¥–ª—è Telegram-–±–æ—Ç–∞ —á–µ—Ä–µ–∑ long polling
- **httpx** ‚Äî –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ (GigaChat, STT, Google) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π async
- **python-dotenv** ‚Äî –¥–ª—è —á—Ç–µ–Ω–∏—è `.env`
- **google-api-python-client** ‚Äî –¥–ª—è Google Calendar API
- **google-auth** ‚Äî –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Service Account
- **sqlite3** ‚Äî –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π SQLite-–±–∞–∑—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å)
- **asyncio** ‚Äî –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- **dataclasses** –∏–ª–∏ **pydantic** ‚Äî –¥–ª—è –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –∫–æ–º–∞–Ω–¥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```python
"""
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
pip install aiogram httpx python-dotenv google-api-python-client google-auth pytz

–î–ª—è STT (–Ø–Ω–¥–µ–∫—Å SpeechKit):
pip install pydub  # –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞—É–¥–∏–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
"""
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –æ–ø–∏—à–∏ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º) –ø—Ä–∏–º–µ—Ä `.env`:

```python
"""
–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ .env:

# Telegram
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11

# GigaChat
GIGACHAT_CLIENT_ID=–≤–∞—à_client_id
GIGACHAT_CLIENT_SECRET=–≤–∞—à_client_secret
GIGACHAT_SCOPE=GIGACHAT_API_PERS

# STT (–Ø–Ω–¥–µ–∫—Å SpeechKit - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
STT_API_KEY=–≤–∞—à_yandex_api_key
STT_FOLDER_ID=–≤–∞—à_folder_id

# Google Calendar
GOOGLE_CREDENTIALS_FILE=service-account.json
GOOGLE_CALENDAR_ID=primary

# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
TIMEZONE=Europe/Moscow
REMINDER_MINUTES_BEFORE=15
REMINDER_CHECK_INTERVAL=60
DATABASE_FILE=events.db
TEMP_DIR=temp
"""
```

**–§—É–Ω–∫—Ü–∏—è `load_config()`:**

```python
@dataclass
class Config:
    telegram_bot_token: str
    gigachat_client_id: str
    gigachat_client_secret: str
    gigachat_scope: str
    stt_api_key: str | None
    stt_folder_id: str | None
    google_credentials_file: str
    google_calendar_id: str
    timezone: str
    reminder_minutes_before: int
    reminder_check_interval: int
    database_file: str
    temp_dir: str

def load_config() -> Config:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    load_dotenv()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    required = ['TELEGRAM_BOT_TOKEN', 'GIGACHAT_CLIENT_ID', 'GIGACHAT_CLIENT_SECRET', 
                'GOOGLE_CREDENTIALS_FILE']
    missing = [var for var in required if not os.getenv(var)]
    if missing:
        raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: {', '.join(missing)}")
    
    return Config(
        telegram_bot_token=os.getenv('TELEGRAM_BOT_TOKEN'),
        gigachat_client_id=os.getenv('GIGACHAT_CLIENT_ID'),
        gigachat_client_secret=os.getenv('GIGACHAT_CLIENT_SECRET'),
        gigachat_scope=os.getenv('GIGACHAT_SCOPE', 'GIGACHAT_API_PERS'),
        stt_api_key=os.getenv('STT_API_KEY'),
        stt_folder_id=os.getenv('STT_FOLDER_ID'),
        google_credentials_file=os.getenv('GOOGLE_CREDENTIALS_FILE'),
        google_calendar_id=os.getenv('GOOGLE_CALENDAR_ID', 'primary'),
        timezone=os.getenv('TIMEZONE', 'Europe/Moscow'),
        reminder_minutes_before=int(os.getenv('REMINDER_MINUTES_BEFORE', '15')),
        reminder_check_interval=int(os.getenv('REMINDER_CHECK_INTERVAL', '60')),
        database_file=os.getenv('DATABASE_FILE', 'events.db'),
        temp_dir=os.getenv('TEMP_DIR', 'temp')
    )
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Calendar

–î–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Service Account** (–ø—Ä–æ—â–µ, —á–µ–º OAuth2).

### –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:

1. **–°–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç –≤ Google Cloud Console:**
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ https://console.cloud.google.com/
   - –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Calendar Bot")

2. **–í–∫–ª—é—á–∏ Google Calendar API:**
   - –í –º–µ–Ω—é "APIs & Services" ‚Üí "Library"
   - –ù–∞–π–¥–∏ "Google Calendar API" –∏ –≤–∫–ª—é—á–∏ –µ–≥–æ

3. **–°–æ–∑–¥–∞–π Service Account:**
   - –í –º–µ–Ω—é "APIs & Services" ‚Üí "Credentials"
   - –ù–∞–∂–º–∏ "Create Credentials" ‚Üí "Service Account"
   - –£–∫–∞–∂–∏ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "calendar-bot")
   - –ù–∞–∂–º–∏ "Create and Continue"
   - –†–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
   - –ù–∞–∂–º–∏ "Done"

4. **–°–∫–∞—á–∞–π JSON-–∫–ª—é—á:**
   - –ù–∞–π–¥–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Service Account –≤ —Å–ø–∏—Å–∫–µ
   - –ù–∞–∂–º–∏ –Ω–∞ –Ω–µ–≥–æ ‚Üí –≤–∫–ª–∞–¥–∫–∞ "Keys"
   - "Add Key" ‚Üí "Create new key" ‚Üí "JSON"
   - –°–æ—Ö—Ä–∞–Ω–∏ —Ñ–∞–π–ª –∫–∞–∫ `service-account.json`

5. **–î–∞–π –¥–æ—Å—Ç—É–ø Service Account –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é:**
   - –û—Ç–∫—Ä–æ–π —Å–∫–∞—á–∞–Ω–Ω—ã–π JSON-—Ñ–∞–π–ª
   - –°–∫–æ–ø–∏—Ä—É–π email Service Account (–ø–æ–ª–µ `client_email`)
   - –û—Ç–∫—Ä–æ–π Google Calendar (https://calendar.google.com/)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ‚Üí "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞"
   - –î–æ–±–∞–≤—å email Service Account —Å –ø—Ä–∞–≤–∞–º–∏ "–í–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"

6. **–£–∫–∞–∂–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ `.env`:**
   ```
   GOOGLE_CREDENTIALS_FILE=service-account.json
   ```

### –ö–æ–¥ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```python
from google.oauth2 import service_account
from googleapiclient.discovery import build

def get_google_calendar_service(config: Config):
    """–°–æ–∑–¥–∞—ë—Ç —Å–µ—Ä–≤–∏—Å Google Calendar —á–µ—Ä–µ–∑ Service Account"""
    credentials = service_account.Credentials.from_service_account_file(
        config.google_credentials_file,
        scopes=['https://www.googleapis.com/auth/calendar']
    )
    return build('calendar', 'v3', credentials=credentials)
```

---

## –õ–æ–≥–∏–∫–∞ Telegram-–±–æ—Ç–∞

–†–µ–∞–ª–∏–∑—É–π –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ:

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import Command
from aiogram.types import Message

bot = Bot(token=config.telegram_bot_token)
dp = Dispatcher()
router = Router()
dp.include_router(router)
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

#### 1. `/start`

```python
@router.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –±—ã—Å—Ç—Ä–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏ –≤ Google –ö–∞–ª–µ–Ω–¥–∞—Ä–µ.\n\n"
        "üìù –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "‚Ä¢ ¬´–ó–∞–≤—Ç—Ä–∞ –≤ 15:00 –≤—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ, —á–∞—Å¬ª\n"
        "‚Ä¢ ¬´–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ –≤ 10:00 —Å–æ–∑–≤–æ–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π, 30 –º–∏–Ω—É—Ç, –æ–Ω–ª–∞–π–Ω¬ª\n"
        "‚Ä¢ ¬´–í –ø—è—Ç–Ω–∏—Ü—É –≤ 18:00 —É–∂–∏–Ω —Å –¥—Ä—É–∑—å—è–º–∏¬ª\n\n"
        f"‚è∞ –ó–∞ {config.reminder_minutes_before} –º–∏–Ω—É—Ç –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –ø—Ä–∏—à–ª—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/help - —Å–ø—Ä–∞–≤–∫–∞\n"
        "/list - –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è\n"
        "/cancel <–Ω–∞–∑–≤–∞–Ω–∏–µ> - –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ"
    )
```

#### 2. `/help`

```python
@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await message.answer(
        "üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:\n\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å—Ç—Ä–µ—á–∏\n"
        "2Ô∏è‚É£ –Ø —Å–æ–∑–¥–∞–º —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–≤–æ—ë–º Google –ö–∞–ª–µ–Ω–¥–∞—Ä–µ\n"
        "3Ô∏è‚É£ –ü–µ—Ä–µ–¥ –≤—Å—Ç—Ä–µ—á–µ–π –ø—Ä–∏—à–ª—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:\n"
        "‚Ä¢ ¬´–ó–∞–≤—Ç—Ä–∞ –≤ 14:00 –≤—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º, 2 —á–∞—Å–∞¬ª\n"
        "‚Ä¢ ¬´–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ –≤ 9:00 –ø–ª–∞–Ω—ë—Ä–∫–∞, 45 –º–∏–Ω—É—Ç, –æ–Ω–ª–∞–π–Ω¬ª\n"
        "‚Ä¢ ¬´–í –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 16:00 –∑–≤–æ–Ω–æ–∫ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º¬ª\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start - –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
        "/list - –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ 5 —Å–æ–±—ã—Ç–∏–π\n"
        "/cancel <–Ω–∞–∑–≤–∞–Ω–∏–µ> - –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é"
    )
```

#### 3. `/list` (–ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è)

```python
@router.message(Command("list", "events"))
async def cmd_list_events(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ 5 —Å–æ–±—ã—Ç–∏–π –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è"""
    try:
        service = get_google_calendar_service(config)
        now = datetime.now(pytz.timezone(config.timezone)).isoformat()
        
        events_result = service.events().list(
            calendarId=config.google_calendar_id,
            timeMin=now,
            maxResults=5,
            singleEvents=True,
            orderBy='startTime'
        ).execute()
        
        events = events_result.get('items', [])
        
        if not events:
            await message.answer("üìÖ –ë–ª–∏–∂–∞–π—à–∏—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return
        
        response = "üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è:\n\n"
        for event in events:
            start = event['start'].get('dateTime', event['start'].get('date'))
            start_dt = datetime.fromisoformat(start.replace('Z', '+00:00'))
            start_local = start_dt.astimezone(pytz.timezone(config.timezone))
            
            response += f"‚Ä¢ {event['summary']}\n"
            response += f"  üïê {start_local.strftime('%d.%m.%Y %H:%M')}\n\n"
        
        await message.answer(response)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π: {e}")
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π")
```

#### 4. `/cancel` (–æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ)

```python
@router.message(Command("cancel"))
async def cmd_cancel_event(message: Message):
    """–û—Ç–º–µ–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é"""
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –∫–æ–º–∞–Ω–¥—ã
    text = message.text.replace('/cancel', '').strip()
    
    if not text:
        await message.answer("‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã:\n/cancel –í—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π")
        return
    
    try:
        service = get_google_calendar_service(config)
        now = datetime.now(pytz.timezone(config.timezone)).isoformat()
        
        # –ò—â–µ–º —Å–æ–±—ã—Ç–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        events_result = service.events().list(
            calendarId=config.google_calendar_id,
            timeMin=now,
            q=text,
            singleEvents=True,
            orderBy='startTime'
        ).execute()
        
        events = events_result.get('items', [])
        
        if not events:
            await message.answer(f"‚ùå –°–æ–±—ã—Ç–∏–µ ¬´{text}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return
        
        # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
        event = events[0]
        service.events().delete(
            calendarId=config.google_calendar_id,
            eventId=event['id']
        ).execute()
        
        # –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
        delete_event_from_db(event['id'])
        
        await message.answer(f"‚úÖ –°–æ–±—ã—Ç–∏–µ ¬´{event['summary']}¬ª –æ—Ç–º–µ–Ω–µ–Ω–æ")
        logging.info(f"–°–æ–±—ã—Ç–∏–µ {event['id']} –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.chat.id}")
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–æ–±—ã—Ç–∏—è: {e}")
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ")
```

#### 5. –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```python
@router.message(F.text & ~F.text.startswith('/'))
async def handle_text_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        await message.answer("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...")
        await handle_natural_language(message.text, message.chat.id, message)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞: {e}")
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ /help"
        )
```

#### 6. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```python
@router.message(F.voice)
async def handle_voice_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        await message.answer("üé§ –†–∞—Å–ø–æ–∑–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...")
        
        # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        os.makedirs(config.temp_dir, exist_ok=True)
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(message.voice.file_id)
        file_path = os.path.join(config.temp_dir, f"voice_{uuid.uuid4()}.ogg")
        await bot.download_file(file.file_path, file_path)
        
        # –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ä–µ—á—å
        text = await speech_to_text(file_path, config)
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        try:
            os.remove(file_path)
        except:
            pass
        
        await message.answer(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {text}")
        await handle_natural_language(text, message.chat.id, message)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º."
        )
```

### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
async def handle_natural_language(text: str, chat_id: int, message: Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫: –ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ GigaChat ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"""
    try:
        # 1. –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ GigaChat
        parsed_event = await parse_event_from_gigachat(text, config)
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤ –±—É–¥—É—â–µ–º
        now = datetime.now(pytz.timezone(config.timezone))
        if parsed_event.start_datetime < now:
            await message.answer("‚ùå –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º. –£–∫–∞–∂–∏—Ç–µ –±—É–¥—É—â—É—é –¥–∞—Ç—É.")
            return
        
        # 3. –°–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ –≤ Google Calendar
        event_id = await create_calendar_event(parsed_event, chat_id, config)
        
        # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        save_event(
            calendar_event_id=event_id,
            chat_id=chat_id,
            title=parsed_event.title,
            start_dt_local=parsed_event.start_datetime,
            reminder_minutes=config.reminder_minutes_before,
            timezone=config.timezone
        )
        
        # 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        end_time = parsed_event.start_datetime + timedelta(minutes=parsed_event.duration_minutes or 60)
        response = (
            f"‚úÖ –°–æ–∑–¥–∞–ª–∞ —Å–æ–±—ã—Ç–∏–µ:\n\n"
            f"üìå {parsed_event.title}\n"
            f"üïê {parsed_event.start_datetime.strftime('%d.%m.%Y %H:%M')} - "
            f"{end_time.strftime('%H:%M')}\n"
        )
        if parsed_event.description:
            response += f"üìù {parsed_event.description}\n"
        response += f"\n‚è∞ –ù–∞–ø–æ–º–Ω—é –∑–∞ {config.reminder_minutes_before} –º–∏–Ω—É—Ç"
        
        await message.answer(response)
        logging.info(f"–°–æ–∑–¥–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ {event_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {chat_id}")
        
    except ValueError as e:
        await message.answer(f"‚ùå {str(e)}")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: {e}")
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
```

---

## –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (STT)

–ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–æ–º –¥–ª—è –Ø–Ω–¥–µ–∫—Å SpeechKit:

```python
async def speech_to_text(file_path: str, config: Config) -> str:
    """
    –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å –∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ STT-–ø—Ä–æ–≤–∞–π–¥–µ—Ä
    
    TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º STT-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º
    –í–∞—Ä–∏–∞–Ω—Ç—ã:
    - –Ø–Ω–¥–µ–∫—Å SpeechKit (https://cloud.yandex.ru/docs/speechkit/)
    - Google Speech-to-Text
    - OpenAI Whisper API
    """
    
    if not config.stt_api_key:
        raise ValueError("STT_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env")
    
    # –ü—Ä–∏–º–µ—Ä –¥–ª—è –Ø–Ω–¥–µ–∫—Å SpeechKit
    try:
        async with httpx.AsyncClient() as client:
            with open(file_path, 'rb') as audio_file:
                response = await client.post(
                    'https://stt.api.cloud.yandex.net/speech/v1/stt:recognize',
                    headers={
                        'Authorization': f'Api-Key {config.stt_api_key}',
                    },
                    params={
                        'lang': 'ru-RU',
                        'folderId': config.stt_folder_id,
                    },
                    content=audio_file.read()
                )
                
                if response.status_code != 200:
                    raise Exception(f"STT API error: {response.status_code}")
                
                result = response.json()
                return result.get('result', '')
                
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ STT: {e}")
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å")
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GigaChat

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞

```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à —Ç–æ–∫–µ–Ω–∞
_gigachat_token_cache = {
    'token': None,
    'expires_at': None
}

async def get_gigachat_access_token(config: Config) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç access token –¥–ª—è GigaChat API —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
    if _gigachat_token_cache['token'] and _gigachat_token_cache['expires_at']:
        if datetime.now() < _gigachat_token_cache['expires_at'] - timedelta(minutes=5):
            return _gigachat_token_cache['token']
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
    try:
        auth_string = f"{config.gigachat_client_id}:{config.gigachat_client_secret}"
        auth_base64 = base64.b64encode(auth_string.encode()).decode()
        
        async with httpx.AsyncClient(verify=False) as client:  # verify=False –¥–ª—è Sberbank API
            response = await client.post(
                'https://ngw.devices.sberbank.ru:9443/api/v2/oauth',
                headers={
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                    'RqUID': str(uuid.uuid4()),
                    'Authorization': f'Basic {auth_base64}'
                },
                data={
                    'scope': config.gigachat_scope
                }
            )
            
            if response.status_code != 200:
                raise Exception(f"GigaChat auth error: {response.status_code}")
            
            data = response.json()
            token = data['access_token']
            expires_at = datetime.fromtimestamp(data['expires_at'] / 1000)
            
            # –ö–µ—à–∏—Ä—É–µ–º
            _gigachat_token_cache['token'] = token
            _gigachat_token_cache['expires_at'] = expires_at
            
            logging.info(f"–ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π GigaChat —Ç–æ–∫–µ–Ω, –∏—Å—Ç–µ–∫–∞–µ—Ç: {expires_at}")
            return token
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è GigaChat —Ç–æ–∫–µ–Ω–∞: {e}")
        raise
```

### –í—ã–∑–æ–≤ GigaChat API

```python
async def call_gigachat(text: str, config: Config) -> dict:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ GigaChat API"""
    
    token = await get_gigachat_access_token(config)
    
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
    system_prompt = """–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –≤—Å—Ç—Ä–µ—á–∞—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–†–û–ì–û JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–ü–æ–ª—è JSON:
- title: –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏ (—Å—Ç—Ä–æ–∫–∞)
- date: –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (—Å—Ç—Ä–æ–∫–∞)
- time: –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM, 24 —á–∞—Å–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null)
- duration_minutes: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö (—á–∏—Å–ª–æ –∏–ª–∏ null)
- description: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞)
- location: –º–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–æ–Ω–ª–∞–π–Ω" - –ø–∏—à–∏ "online" (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null)

–ü—Ä–∞–≤–∏–ª–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏, —Ç–µ–∫—É—â–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞: {timezone}
2. "–°–µ–≥–æ–¥–Ω—è" = —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞, "–∑–∞–≤—Ç—Ä–∞" = +1 –¥–µ–Ω—å, "–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞" = +2 –¥–Ω—è
3. –î–Ω–∏ –Ω–µ–¥–µ–ª–∏: "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤ –ø—è—Ç–Ω–∏—Ü—É" = –±–ª–∏–∂–∞–π—à–∏–π —Ç–∞–∫–æ–π –¥–µ–Ω—å
4. "–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" = +7 –¥–Ω–µ–π, "—á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏" = +14 –¥–Ω–µ–π
5. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ "—Å 15:00 –¥–æ 16:30", —Ç–æ time=15:00, duration_minutes=90
6. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "—á–∞—Å" = 60 –º–∏–Ω—É—Ç, "–ø–æ–ª—á–∞—Å–∞" = 30 –º–∏–Ω—É—Ç, "2 —á–∞—Å–∞" = 120 –º–∏–Ω—É—Ç
7. –ï—Å–ª–∏ –≤—Ä–µ–º—è –ù–ï —É–∫–∞–∑–∞–Ω–æ - –≤–µ—Ä–Ω–∏ time: null –∏ duration_minutes: null
8. –ï—Å–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ù–ï —É–∫–∞–∑–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å –≤—Ä–µ–º—è - –≤–µ—Ä–Ω–∏ duration_minutes: null
9. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–æ–Ω–ª–∞–π–Ω", "zoom", "meet" - –¥–æ–±–∞–≤—å location: "online"

–ü—Ä–∏–º–µ—Ä—ã:

–í—Ö–æ–¥: "–ó–∞–≤—Ç—Ä–∞ –≤ 15:00 –≤—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ, —á–∞—Å"
–í—ã—Ö–æ–¥: {"title": "–í—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ", "date": "2024-01-16", "time": "15:00", "duration_minutes": 60, "description": "", "location": null}

–í—Ö–æ–¥: "–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ –≤ 10:00 —Å–æ–∑–≤–æ–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π, 30 –º–∏–Ω—É—Ç, –æ–Ω–ª–∞–π–Ω"
–í—ã—Ö–æ–¥: {"title": "–°–æ–∑–≤–æ–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π", "date": "2024-01-17", "time": "10:00", "duration_minutes": 30, "description": "", "location": "online"}

–í—Ö–æ–¥: "–í –ø—è—Ç–Ω–∏—Ü—É –≤ 18:00 —É–∂–∏–Ω —Å –¥—Ä—É–∑—å—è–º–∏"
–í—ã—Ö–æ–¥: {"title": "–£–∂–∏–Ω —Å –¥—Ä—É–∑—å—è–º–∏", "date": "2024-01-19", "time": "18:00", "duration_minutes": null, "description": "", "location": null}

–í—Ö–æ–¥: "–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –ø–ª–∞–Ω—ë—Ä–∫–∞ —Å 9:00 –¥–æ 10:30"
–í—ã—Ö–æ–¥: {"title": "–ü–ª–∞–Ω—ë—Ä–∫–∞", "date": "2024-01-22", "time": "09:00", "duration_minutes": 90, "description": "", "location": null}

–í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ markdown, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""
    
    system_prompt = system_prompt.replace('{timezone}', config.timezone)
    
    try:
        async with httpx.AsyncClient(verify=False, timeout=30.0) as client:
            response = await client.post(
                'https://gigachat.devices.sberbank.ru/api/v1/chat/completions',
                headers={
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': f'Bearer {token}'
                },
                json={
                    'model': 'GigaChat',
                    'messages': [
                        {'role': 'system', 'content': system_prompt},
                        {'role': 'user', 'content': text}
                    ],
                    'temperature': 0.1,
                    'max_tokens': 500
                }
            )
            
            if response.status_code != 200:
                raise Exception(f"GigaChat API error: {response.status_code} - {response.text}")
            
            return response.json()
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ GigaChat: {e}")
        raise
```

### –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ GigaChat

```python
@dataclass
class ParsedEvent:
    """–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è"""
title: str
    start_datetime: datetime
duration_minutes: int | None
description: str
    location: str | None = None

async def parse_event_from_gigachat(text: str, config: Config) -> ParsedEvent:
    """–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ GigaChat –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ"""
    
    # –í—ã–∑—ã–≤–∞–µ–º GigaChat
    response = await call_gigachat(text, config)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    content = response['choices'][0]['message']['content']
    logging.info(f"GigaChat –æ—Ç–≤–µ—Ç: {content}")
    
    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
    try:
        # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        content = content.strip()
        if content.startswith('```'):
            content = content.split('```')[1]
            if content.startswith('json'):
                content = content[4:]
        content = content.strip()
        
        data = json.loads(content)
        
    except json.JSONDecodeError:
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–∫—É
        import re
        match = re.search(r'\{.*\}', content, re.DOTALL)
        if match:
            data = json.loads(match.group())
        else:
            raise ValueError("GigaChat –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if not data.get('title'):
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏")
    
    if not data.get('date'):
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∞—Ç—É –≤—Å—Ç—Ä–µ—á–∏")
    
    if not data.get('time'):
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏. –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è —è–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '15:00')")
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ datetime
    try:
        date_str = data['date']
        time_str = data['time']
        datetime_str = f"{date_str} {time_str}"
        
        tz = pytz.timezone(config.timezone)
        start_datetime = tz.localize(datetime.strptime(datetime_str, '%Y-%m-%d %H:%M'))
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏: {e}")
        raise ValueError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏")
    
    return ParsedEvent(
        title=data['title'],
        start_datetime=start_datetime,
        duration_minutes=data.get('duration_minutes'),
        description=data.get('description', ''),
        location=data.get('location')
    )
```

---

## Google Calendar - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

```python
async def create_calendar_event(event: ParsedEvent, chat_id: int, config: Config) -> str:
    """–°–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ –≤ Google Calendar –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç event_id"""
    
    service = get_google_calendar_service(config)
    
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    duration = event.duration_minutes or 60  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 –º–∏–Ω—É—Ç
    end_datetime = event.start_datetime + timedelta(minutes=duration)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ —Å–æ–±—ã—Ç–∏—è
    event_body = {
        'summary': event.title,
        'description': event.description,
        'start': {
            'dateTime': event.start_datetime.isoformat(),
            'timeZone': config.timezone,
        },
        'end': {
            'dateTime': end_datetime.isoformat(),
            'timeZone': config.timezone,
        },
        'reminders': {
            'useDefault': False,
            'overrides': [
                {'method': 'popup', 'minutes': config.reminder_minutes_before},
            ],
        },
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º location, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
    if event.location:
        event_body['location'] = event.location
    
    # –°–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ
    try:
        created_event = service.events().insert(
            calendarId=config.google_calendar_id,
            body=event_body
        ).execute()
        
        event_id = created_event['id']
        logging.info(f"–°–æ–∑–¥–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ –≤ Google Calendar: {event_id}")
        return event_id
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Google Calendar: {e}")
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ")
```

---

## SQLite - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```python
def init_db(config: Config):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(config.database_file)
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            calendar_event_id TEXT NOT NULL,
            chat_id INTEGER NOT NULL,
            title TEXT NOT NULL,
            start_datetime_utc TEXT NOT NULL,
            reminder_datetime_utc TEXT NOT NULL,
            reminder_sent INTEGER DEFAULT 0,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    cursor.execute('''
        CREATE INDEX IF NOT EXISTS idx_reminder 
        ON events(reminder_sent, reminder_datetime_utc)
    ''')
    
    cursor.execute('''
        CREATE INDEX IF NOT EXISTS idx_calendar_event 
        ON events(calendar_event_id)
    ''')
    
    conn.commit()
    conn.close()
    logging.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

def save_event(calendar_event_id: str, chat_id: int, title: str, 
               start_dt_local: datetime, reminder_minutes: int, timezone: str):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –ë–î"""
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ UTC
    start_dt_utc = start_dt_local.astimezone(pytz.UTC)
    reminder_dt_local = start_dt_local - timedelta(minutes=reminder_minutes)
    reminder_dt_utc = reminder_dt_local.astimezone(pytz.UTC)
    
    conn = sqlite3.connect(config.database_file)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO events (calendar_event_id, chat_id, title, start_datetime_utc, 
                           reminder_datetime_utc, reminder_sent)
        VALUES (?, ?, ?, ?, ?, 0)
    ''', (
        calendar_event_id,
        chat_id,
        title,
        start_dt_utc.isoformat(),
        reminder_dt_utc.isoformat()
    ))
    
    conn.commit()
    conn.close()
    logging.info(f"–°–æ–±—ã—Ç–∏–µ {calendar_event_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î")

def delete_event_from_db(calendar_event_id: str):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑ –ë–î"""
    conn = sqlite3.connect(config.database_file)
    cursor = conn.cursor()
    cursor.execute('DELETE FROM events WHERE calendar_event_id = ?', (calendar_event_id,))
    conn.commit()
    conn.close()
    logging.info(f"–°–æ–±—ã—Ç–∏–µ {calendar_event_id} —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ë–î")
```

---

## –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ Telegram

```python
async def reminder_worker(bot: Bot, config: Config):
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    logging.info("–ó–∞–ø—É—â–µ–Ω reminder_worker")
    
    while True:
        try:
            # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC
            now_utc = datetime.now(pytz.UTC)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            conn = sqlite3.connect(config.database_file)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT id, calendar_event_id, chat_id, title, start_datetime_utc
                FROM events
                WHERE reminder_sent = 0 
                AND reminder_datetime_utc <= ?
            ''', (now_utc.isoformat(),))
            
            events = cursor.fetchall()
            
            for event_id, calendar_event_id, chat_id, title, start_datetime_utc in events:
                try:
                    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é —Ç–∞–π–º–∑–æ–Ω—É
                    start_dt = datetime.fromisoformat(start_datetime_utc).replace(tzinfo=pytz.UTC)
                    start_local = start_dt.astimezone(pytz.timezone(config.timezone))
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                    message = (
                        f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\n"
                        f"üìå {title}\n"
                        f"üïê {start_local.strftime('%d.%m.%Y –≤ %H:%M')}\n\n"
                        f"–ß–µ—Ä–µ–∑ {config.reminder_minutes_before} –º–∏–Ω—É—Ç"
                    )
                    
                    await bot.send_message(chat_id, message)
                    
                    # –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
                    cursor.execute('''
                        UPDATE events SET reminder_sent = 1 WHERE id = ?
                    ''', (event_id,))
                    conn.commit()
                    
                    logging.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —Å–æ–±—ã—Ç–∏—è {calendar_event_id}")
                    
                except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —Å–æ–±—ã—Ç–∏—è {event_id}: {e}")
            
            conn.close()
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –≤ reminder_worker: {e}")
        
        # –ñ–¥—ë–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        await asyncio.sleep(config.reminder_check_interval)
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:

```python
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

# –û—Ç–∫–ª—é—á–∞–µ–º –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫
logging.getLogger('httpx').setLevel(logging.WARNING)
logging.getLogger('aiogram').setLevel(logging.INFO)
```

**–ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**

- `INFO`: —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `WARNING`: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
- `ERROR`: –æ—à–∏–±–∫–∏ API, –ø–∞—Ä—Å–∏–Ω–≥–∞, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- `DEBUG`: –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## Graceful Shutdown

–î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:

```python
import signal

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
shutdown_event = asyncio.Event()

def signal_handler(sig, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
    logging.info(f"–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {sig}, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...")
    shutdown_event.set()

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    global config
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    try:
        config = load_config()
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        return
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
    init_db(config)
    
    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    os.makedirs(config.temp_dir, exist_ok=True)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º reminder_worker
    reminder_task = asyncio.create_task(reminder_worker(bot, config))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º polling –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
    polling_task = asyncio.create_task(dp.start_polling(bot))
    
    logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    
    # –ñ–¥—ë–º —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    await shutdown_event.wait()
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling
    logging.info("–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling...")
    polling_task.cancel()
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º reminder_worker
    logging.info("–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º reminder_worker...")
    reminder_task.cancel()
    
    # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á
    await asyncio.gather(polling_task, reminder_task, return_exceptions=True)
    
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞
    await bot.session.close()
    
    logging.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

if __name__ == '__main__':
    asyncio.run(main())
```

---

## –°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install aiogram httpx python-dotenv google-api-python-client google-auth pytz

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è STT:
pip install pydub
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# 2. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª .env
cat > .env << EOF
TELEGRAM_BOT_TOKEN=—Ç–≤–æ–π_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather
GIGACHAT_CLIENT_ID=—Ç–≤–æ–π_client_id
GIGACHAT_CLIENT_SECRET=—Ç–≤–æ–π_client_secret
GIGACHAT_SCOPE=GIGACHAT_API_PERS
GOOGLE_CREDENTIALS_FILE=service-account.json
GOOGLE_CALENDAR_ID=primary
TIMEZONE=Europe/Moscow
REMINDER_MINUTES_BEFORE=15
EOF

# 3. –ù–∞—Å—Ç—Ä–æ–π Google Calendar (—Å–º. —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Calendar")
# 4. –ü–æ–ª–æ–∂–∏ —Ñ–∞–π–ª service-account.json –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –±–æ—Ç–æ–º
```

### –ó–∞–ø—É—Å–∫

```bash
# –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
python bot.py

# –ò–ª–∏ –≤ —Ñ–æ–Ω–µ (Linux)
nohup python bot.py > bot.log 2>&1 &
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. –ù–∞–π–¥–∏ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å `/start`
3. –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
   - "–ó–∞–≤—Ç—Ä–∞ –≤ 15:00 –≤—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ, —á–∞—Å"
   - "–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ –≤ 10:00 —Å–æ–∑–≤–æ–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π, 30 –º–∏–Ω—É—Ç, –æ–Ω–ª–∞–π–Ω"
   - "–í –ø—è—Ç–Ω–∏—Ü—É –≤ 18:00 —É–∂–∏–Ω —Å –¥—Ä—É–∑—å—è–º–∏"

4. –ë–æ—Ç —Å–æ–∑–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ—Ç–≤–µ—Ç–∏—Ç:
   ```
   ‚úÖ –°–æ–∑–¥–∞–ª–∞ —Å–æ–±—ã—Ç–∏–µ:
   
   üìå –í—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ
   üïê 16.01.2024 15:00 - 16:00
   
   ‚è∞ –ù–∞–ø–æ–º–Ω—é –∑–∞ 15 –º–∏–Ω—É—Ç
   ```

5. –ó–∞ 15 –º–∏–Ω—É—Ç –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –ø–æ–ª—É—á–∏—à—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:
   ```
   ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!
   
   üìå –í—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π –ø–æ –∏–ø–æ—Ç–µ–∫–µ
   üïê 16.01.2024 –≤ 15:00
   
   –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
   ```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

- `/list` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ 5 —Å–æ–±—ã—Ç–∏–π
- `/cancel –í—Å—Ç—Ä–µ—á–∞ —Å –ö–∞—Ç–µ–π` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
- `/help` ‚Äî —Å–ø—Ä–∞–≤–∫–∞

---

## –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **Type hints** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –æ–±–æ—Ä–∞—á–∏–≤–∞–π —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ try-except
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ª–æ–≥–∏—Ä—É–π –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –æ—à–∏–±–∫–∏
4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** ‚Äî —Ä–∞–∑–¥–µ–ª—è–π –∫–æ–¥ –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
5. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** ‚Äî –¥–æ–±–∞–≤–ª—è–π docstrings –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
6. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã** ‚Äî –≤—ã–Ω–æ—Å–∏ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

```python
# –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ —Å retry
async def call_api_with_retry(func, max_retries=3):
    """–í—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    for attempt in range(max_retries):
        try:
            return await func()
        except httpx.RequestError as e:
            if attempt == max_retries - 1:
                raise
            logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
            await asyncio.sleep(2 ** attempt)  # Exponential backoff

# –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
def validate_event_data(data: dict) -> None:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è"""
    required_fields = ['title', 'date', 'time']
    missing = [f for f in required_fields if not data.get(f)]
    if missing:
        raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: {', '.join(missing)}")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
async def check_time_conflicts(start_dt: datetime, end_dt: datetime, config: Config) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ"""
    service = get_google_calendar_service(config)
    events = service.events().list(
        calendarId=config.google_calendar_id,
        timeMin=start_dt.isoformat(),
        timeMax=end_dt.isoformat(),
        singleEvents=True
    ).execute()
    return len(events.get('items', [])) > 0
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `TELEGRAM_BOT_TOKEN` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `tail -f bot.log`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω: `ps aux | grep bot.py`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ GigaChat

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å `GIGACHAT_CLIENT_ID` –∏ `GIGACHAT_CLIENT_SECRET`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ scope –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: `GIGACHAT_API_PERS`
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Sberbank –¥–æ—Å—Ç—É–ø–Ω—ã (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π `verify=False`)

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è –≤ Google Calendar

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Service Account email –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫ `service-account.json`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ Google Calendar API –≤–∫–ª—é—á—ë–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `reminder_worker` –∑–∞–ø—É—â–µ–Ω (—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏)
- –ü—Ä–æ–≤–µ—Ä—å `REMINDER_CHECK_INTERVAL` ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î: `sqlite3 events.db "SELECT * FROM events;"`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å `STT_API_KEY` –∏ `STT_FOLDER_ID`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (OGG)
- –ü–æ–ø—Ä–æ–±—É–π –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –≤ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç (–∏—Å–ø–æ–ª—å–∑—É–π `pydub`)

### –ü—Ä–æ–±–ª–µ–º–∞: GigaChat –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –¥–∞—Ç—É/–≤—Ä–µ–º—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–ø—Ä–æ–±—É–π –±–æ–ª–µ–µ —è–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: "16 —è–Ω–≤–∞—Ä—è –≤ 15:00" –≤–º–µ—Å—Ç–æ "–∑–∞–≤—Ç—Ä–∞ –≤ 3 –¥–Ω—è"
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `TIMEZONE` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ ‚Äî —Ç–∞–º –±—É–¥–µ—Ç –æ—Ç–≤–µ—Ç GigaChat

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –û—á–∏—â–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: –ø—Ä–æ–≤–µ—Ä—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `temp/`
- –û–≥—Ä–∞–Ω–∏—á—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–∞: –∏—Å–ø–æ–ª—å–∑—É–π `RotatingFileHandler`
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–π —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –ë–î

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞

```python
#!/usr/bin/env python3
"""
Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google Calendar —á–µ—Ä–µ–∑ GigaChat

–£—Å—Ç–∞–Ω–æ–≤–∫–∞: pip install aiogram httpx python-dotenv google-api-python-client google-auth pytz
–ó–∞–ø—É—Å–∫: python bot.py
"""

# =============================
# IMPORTS
# =============================
import os
import asyncio
import logging
import sqlite3
import uuid
import base64
import json
import signal
from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Optional

import httpx
import pytz
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import Command
from aiogram.types import Message
from google.oauth2 import service_account
from googleapiclient.discovery import build

# =============================
# CONFIGURATION & SETTINGS
# =============================
# ... (–∫–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)

# =============================
# LOGGING SETUP
# =============================
# ... (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

# =============================
# DATABASE FUNCTIONS
# =============================
# ... (init_db, save_event, delete_event_from_db)

# =============================
# GIGACHAT INTEGRATION
# =============================
# ... (get_gigachat_access_token, call_gigachat, parse_event_from_gigachat)

# =============================
# GOOGLE CALENDAR INTEGRATION
# =============================
# ... (get_google_calendar_service, create_calendar_event)

# =============================
# SPEECH-TO-TEXT (STT)
# =============================
# ... (speech_to_text)

# =============================
# TELEGRAM BOT HANDLERS
# =============================
# ... (cmd_start, cmd_help, cmd_list_events, cmd_cancel_event, 
#      handle_text_message, handle_voice_message, handle_natural_language)

# =============================
# REMINDER WORKER
# =============================
# ... (reminder_worker)

# =============================
# GRACEFUL SHUTDOWN
# =============================
# ... (signal_handler, shutdown_event)

# =============================
# MAIN APPLICATION
# =============================
# ... (main)

if __name__ == '__main__':
    asyncio.run(main())
```

---

**–ì–æ—Ç–æ–≤–æ!** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram-–±–æ—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π GigaChat –∏ Google Calendar. –°–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∏ —É —Ç–µ–±—è –ø–æ–ª—É—á–∏—Ç—Å—è —Ä–∞–±–æ—á–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
