# Дневник питания (Food Log)

Модуль для ведения дневника питания в Telegram-боте "Агафья".

## Описание

Дневник питания позволяет записывать информацию о приёмах пищи и продуктах, которые вы ели. Данные сохраняются в локальной SQLite базе данных.

## Использование

### Кодовые слова

Для гарантированной записи в дневник питания начните сообщение с кодового слова:
- `menu` (английский)
- `меню` (русский)

Примеры:
- "menu овсянка 200 грамм"
- "меню творог 40г"
- "menu завтрак: омлет и кофе"

Кодовые слова настраиваются в файле `features/food/config.py` в списке `FOOD_CODE_WORDS`.

### Записи о еде (без кодового слова)

Отправьте текстовое или голосовое сообщение с описанием еды:

- "Еда: завтрак омлет и кофе"
- "Меню за день: утром овсянка; днем борщ и хлеб; вечером рыба и овощи"
- "Съела салат цезарь и капучино"
- "Перекус: яблоко, йогурт"
- "Вчера: паста и салат"

### Команды

- `/food_help` - справка по дневнику питания
- `/food_today` - что записано за сегодня
- `/food_day YYYY-MM-DD` - лог за указанную дату
- `/food_last N` - последние N записей (по умолчанию 10)
- `/food_sum YYYY-MM-DD` - сводка за день (количество записей, приёмы пищи, список продуктов)
- `/food_delete ID` - удалить запись по ID
- `/food_export YYYY-MM-DD` - экспорт данных за дату в CSV файл

## Определение интента

Система автоматически определяет, является ли сообщение записью о еде или событием календаря:

1. **Календарь** (высокий приоритет): если сообщение содержит ключевые слова календаря (дата+время+встреча/запись/маникюр/врач)
2. **Еда**: если сообщение содержит ключевые слова о еде (еда, съел, завтрак, обед, ужин, перекус, названия продуктов)
3. **По умолчанию**: календарь (как раньше)

## Структура данных

Записи сохраняются в таблице `food_logs`:

- `id` - уникальный идентификатор
- `user_id` - ID пользователя Telegram
- `created_at` - дата/время создания записи (ISO format)
- `event_date` - дата события (YYYY-MM-DD)
- `meal_type` - тип приёма пищи (breakfast|lunch|dinner|snack|unknown)
- `items_json` - JSON массив продуктов
- `raw_text` - исходный текст сообщения
- `source` - источник ('telegram')
- `parse_mode` - режим парсинга ('rules'|'llm')
- `tz` - временная зона

## Парсинг

Парсинг выполняется по правилам (rules-based), без использования внешних LLM моделей. Поддерживается:

- Определение даты (сегодня, завтра, вчера, послезавтра, YYYY-MM-DD)
- Определение типа приёма пищи (завтрак, обед, ужин, перекус)
- Извлечение списка продуктов (разделители: запятые, точки с запятой, "и", "с")
- Извлечение количества (граммы, миллилитры)

## Архитектура

Модуль состоит из следующих компонентов:

- `config.py` - конфигурация (кодовые слова и другие настройки)
- `intent_router.py` - определение интента (еда vs календарь)
- `food_nlu.py` - парсинг сообщений о еде
- `food_db.py` - работа с базой данных (CRUD операции)
- `food_handlers.py` - обработчики команд и сообщений

### Настройка кодовых слов

Кодовые слова для дневника питания настраиваются в файле `features/food/config.py`:

```python
FOOD_CODE_WORDS: List[str] = [
    'menu',
    'меню',
    # Добавьте свои кодовые слова здесь
]
```

Для добавления нового кодового слова просто добавьте его в список `FOOD_CODE_WORDS`.

### Исправление ошибок распознавания речи

Ошибки распознавания речи (например, "миню" вместо "меню") исправляются автоматически. 
Настройки находятся в файле `features/food/config.py`:

```python
# Исправления для кодовых слов
SPEECH_CORRECTIONS_CODE_WORDS: Dict[str, str] = {
    'миню': 'меню',
    'мину': 'меню',
    'мену': 'меню',
    # Добавьте свои исправления здесь
}

# Исправления для продуктов и других слов (регулярные выражения)
SPEECH_CORRECTIONS_PATTERNS: Dict[str, str] = {
    r'\bотстану\s+кашу\b': 'овсяную кашу',
    # Добавьте свои паттерны здесь
}
```

Для добавления нового исправления добавьте его в соответствующий словарь.

## Интеграция

Модуль интегрирован в основной файл `bot.py`:

- Router определяет интент перед обработкой сообщения
- Текстовые и голосовые сообщения обрабатываются через router
- Команды `/food_*` зарегистрированы в роутере бота
- Таблица `food_logs` создаётся автоматически при инициализации БД

## Backward Compatibility

Все существующие функции календаря работают без изменений:

- Создание событий в Google Calendar
- Обработка голосовых сообщений через STT
- Команды календаря (/start, /help, /list, /cancel)
- Нормализация текста через GigaChat

Новый функционал добавлен как отдельный модуль, не затрагивая существующий код календаря.

